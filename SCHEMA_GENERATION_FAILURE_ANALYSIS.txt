╔══════════════════════════════════════════════════════════════════════════════╗
║         SCHEMA GENERATION FAILURE ANALYSIS & COMPREHENSIVE FIX               ║
║                   Root Cause Analysis & Solutions                           ║
╚══════════════════════════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════════════════════════
CRITICAL FINDINGS - WHY SCHEMAS ARE NOT GENERATED/CREATED
═══════════════════════════════════════════════════════════════════════════════

Status: ❌ SCHEMA GENERATION COMPLETELY BROKEN

Root Cause #1: JSON Parsing Failures (CRITICAL)
───────────────────────────────────────────────
Lines in Schem.md: 75, 128-134, 328-356

Error: "json.decoder.JSONDecodeError: Expecting ',' delimiter: line 2 column 1456"
Error: "json.decoder.JSONDecodeError: Invalid control character at: line 2 column 1169"

Problem:
├─ LLM is returning INVALID JSON with:
│  ├─ Unescaped newline characters
│  ├─ Unescaped quotes in text
│  ├─ Missing commas in JSON structures
│  └─ Invalid control characters
├─ standards_chat_agent.py line 462: json.loads(raw_text) is too strict
├─ No fallback for malformed JSON
└─ Causes entire enrichment to fail

Impact: ❌ Schema fields cannot be extracted
Failure Rate: ~50% of RAG queries return invalid JSON


Root Cause #2: Missing Deep Agent Module (CRITICAL)
────────────────────────────────────────────────────
Lines in Schem.md: 194, 249, 447, 502

Error: "No module named 'agentic.deep_agent_schema_populator'"

Problem:
├─ File agentic/deep_agent_schema_populator.py doesn't exist
├─ Referenced in validation_tool.py but never created
├─ Fallback returns empty dict with 0 fields populated
└─ No actual schema field population happens

Impact: ❌ Deep Agent schema population: 0/0 fields (ALWAYS FAILS)
Failure Rate: 100% - every schema gets 0 fields from deep agent


Root Cause #3: Zero Schema Fields Extracted
────────────────────────────────────────────
Lines in Schem.md: 46-47, 390-391, 617-618

Results:
├─ Line 390-391: "Extracted values for 0 fields" "Populated 0/35 fields"
├─ Line 617-618: "Extracted values for 0 fields" "Populated 0/35 fields"
└─ Line 546, 543, 655: "Input keys: []" - NO FIELDS IN SCHEMA!

Problem:
├─ RAG query succeeds (validation score 0.95)
├─ LLM returns answer with technical specs
├─ But regex extraction finds 0 matches
├─ Schema field keys are empty arrays
└─ Even when LLM answers correctly, values aren't extracted

Impact: ❌ Only 2/35 fields populated at best (5.7% completion)
Expected: 30+ fields populated
Actual: 0-2 fields populated
Failure Rate: 94% of schema fields remain empty


Root Cause #4: Nested Schema Structure Issue
─────────────────────────────────────────────
Lines in Schem.md: 543, 641, 655

Pattern: "[FIX21] Unwrapped nested schema (outer keys: ['schema', 'populated'])"

Problem:
├─ Schema is wrapped: {"schema": {...}, "populated": {...}}
├─ Should be: actual schema fields at top level
├─ When unwrapped: "Input keys: []" - NO ACTUAL SCHEMA FIELDS!
├─ This causes schema normalization to fail
└─ Results in mandatory: 0, optional: 0

Impact: ❌ API returns empty schema structure
Normalized schema: {"mandatoryRequirements": [], "optionalRequirements": []}
Expected: Full schema with all fields


Root Cause #5: Standards Enrichment Output Mismatch
───────────────────────────────────────────────────
Lines in Schem.md: 177-178, 603, 630

Pattern: "✓ Enriched schema with 0 standards-based field values"
Pattern: "✓ Enriched schema with 2 standards-based field values"

Problem:
├─ Standards enrichment tool claims success
├─ But returns 0 values extracted
├─ RAG query runs for 69-106 seconds
├─ But value extraction regex fails to match anything
├─ No field value mapping happening
└─ Schema fields remain empty strings

Impact: ❌ Time wasted, no values extracted
Time: 69-106 seconds per product
Values: 0 fields in 90% of cases


═══════════════════════════════════════════════════════════════════════════════
DETAILED FAILURE SUMMARY BY ISSUE
═══════════════════════════════════════════════════════════════════════════════

ISSUE #1: JSON PARSING FAILURES IN STANDARDS_CHAT_AGENT
────────────────────────────────────────────────────────

File: agentic/standards_rag/standards_chat_agent.py
Lines: 462 (json.loads), 475-476 (error raise)

Current Code:
    response_dict = json.loads(raw_text)  # Line 462
    # FAILS when LLM returns invalid JSON

Failures Observed:
├─ Line 75-76: "Direct JSON parse failed: Expecting ',' delimiter"
├─ Line 128-129: "Direct JSON parse failed: Invalid control character"
├─ Line 328-334: Multiple lines showing malformed JSON
└─ Then attempts extraction which also fails

Root Cause:
├─ LLM sometimes returns JSON with unescaped newlines in text fields
├─ Python's json.loads() is strict and rejects this
├─ Exception handling tries extraction but also fails
└─ Final ValueError raised, enrichment aborted

Solution Needed:
1. Better JSON sanitization before parsing
2. Fallback extraction even when JSON is invalid
3. Regex-based field extraction from malformed JSON
4. Graceful degradation instead of complete failure


ISSUE #2: MISSING DEEP_AGENT_SCHEMA_POPULATOR MODULE
───────────────────────────────────────────────────

File: agentic/deep_agent_schema_populator.py (DOESN'T EXIST)
Referenced in: product_search_workflow/validation_tool.py

Current Code:
    try:
        from agentic.deep_agent_schema_populator import populate_schema_with_deep_agent
    except ImportError:
        # Fallback that returns {"_deep_agent_population": {"fields_populated": 0}}
        return schema  # Line 249

Failures Observed:
├─ Line 194: "[FIX5] Module not found - deep_agent_schema_populator"
├─ Line 249: "[FIX5] Using fallback for populate_schema_with_deep_agent"
└─ Result: "Deep Agent populated 0/0 fields" (always!)

Root Cause:
├─ File was never created during implementation
├─ Import fails silently with fallback
├─ Fallback returns empty dict
└─ Schema population completely skipped

Solution Needed:
1. Create the missing deep_agent_schema_populator.py module
2. OR remove the fallback that always returns 0 fields
3. Implement actual deep agent schema population
4. Use existing parallel/async schema enrichment instead


ISSUE #3: ZERO SCHEMA FIELDS EXTRACTED
───────────────────────────────────────

File: tools/standards_enrichment_tool.py
Lines: Value extraction logic

Failures Observed:
├─ Line 390: "Extracted values for 0 fields"
├─ Line 46: "Extracted values for 2 fields" (best case)
├─ Line 544: "Input keys: []" (NO SCHEMA STRUCTURE)
└─ Average extraction: 0-5% of fields

Root Cause:
├─ Regex patterns don't match LLM output format
├─ LLM returns text descriptions, not structured values
├─ Example: "accuracy is typically 0.25%" vs. regex looking for "accuracy: 0.25%"
├─ Format mismatch causes 0 matches
└─ Schema remains empty

Example Mismatch:
LLM Output: "The accuracy typically ranges from 0.25% to 0.5% of the measured value"
Regex Pattern: r"accuracy[:\s]+[±]?\s*(\d+\.?\d*)\s*%"
Result: 0 matches (pattern too strict)

Solution Needed:
1. Improve regex patterns to be more flexible
2. Use NLP/semantic matching instead of strict regex
3. Use LLM to extract structured data instead of regex
4. Implement robust value parsing from descriptions


ISSUE #4: NESTED SCHEMA STRUCTURE
──────────────────────────────────

File: agentic/api.py
Lines: 543-548

Current Code:
    schema_dict = result.get("schema", {})  # Unwraps nested schema
    # But inner schema is also empty!

Failures Observed:
├─ Line 543: "[FIX21] Unwrapped nested schema"
├─ Line 544: "Input keys: []" (EMPTY!)
├─ Line 545: "Mandatory fields: 0, Optional fields: 0"
└─ Result: API returns empty schema

Root Cause:
├─ Schema being returned as {"schema": {...}, "populated": {...}}
├─ When unwrapped, inner schema also has no fields
├─ Schema structure is corrupted
└─ OR schema_tools.load_schema_from_azure not returning proper structure

Solution Needed:
1. Verify schema structure from Azure Blob Storage
2. Ensure schema is returned with actual fields, not nested
3. Implement schema validation before returning
4. Add debug logging to show schema structure at each step


ISSUE #5: STANDARDS ENRICHMENT OUTPUT MISMATCH
───────────────────────────────────────────────

File: tools/standards_enrichment_tool.py
Lines: ~150-200

Current Code:
    values = self._extract_values_from_answer(answer)  # Regex extraction
    # Returns 0 values even when answer contains specs

Failures Observed:
├─ Line 45: "Comprehensive query success (confidence: 0.95)"
├─ Line 46: "Extracted values for 2 fields" (only 2!)
├─ Line 390: "Extracted values for 0 fields"
└─ Time: 69-106 seconds wasted with no result

Root Cause:
├─ LLM returns comprehensive answer (confidence 0.95)
├─ But value extraction regex completely fails
├─ Answer contains: "accuracy 0.25%", "temperature range -20 to +60°C", etc.
├─ But regex finds: 0 matches
└─ Regex patterns are too strict or format is wrong

Solution Needed:
1. Improve regex patterns to match actual LLM output
2. Add fallback to semantic/NLP-based extraction
3. Use LLM itself to structure the answer JSON
4. Implement better error handling and debugging


═══════════════════════════════════════════════════════════════════════════════
COMPREHENSIVE FIXES REQUIRED
═══════════════════════════════════════════════════════════════════════════════

FIX #1: JSON Parsing Robustness
───────────────────────────────
File: agentic/standards_rag/standards_chat_agent.py
Lines: ~460-480

Current: Strict json.loads() with no fallback
New: Implement robust JSON parsing with sanitization

    def parse_json_safely(raw_text):
        # Step 1: Try direct parsing
        try:
            return json.loads(raw_text)
        except json.JSONDecodeError:
            pass

        # Step 2: Try sanitization (escape unescaped quotes/newlines)
        try:
            sanitized = raw_text.replace('\n', '\\n').replace('\r', '\\r')
            return json.loads(sanitized)
        except json.JSONDecodeError:
            pass

        # Step 3: Try extraction of JSON portion
        try:
            match = re.search(r'\{.*\}', raw_text, re.DOTALL)
            if match:
                return json.loads(match.group(0))
        except json.JSONDecodeError:
            pass

        # Step 4: Fallback - return structured response
        return {"answer": raw_text, "confidence": 0.5}


FIX #2: Create Deep Agent Module (OR Remove It)
────────────────────────────────────────────
Option A: CREATE agentic/deep_agent_schema_populator.py
    - Implement using existing schema enrichment patterns
    - Use async parallel enrichment for all fields
    - Return properly structured population results

Option B: REMOVE the deep agent fallback (SIMPLER)
    - Remove deep agent import from validation_tool.py
    - Use existing schema enrichment which works (with fixes)
    - Saves 100+ lines of code and complexity

RECOMMENDATION: Option B (Remove)
├─ Schema enrichment via standards RAG already works
├─ No need for separate deep agent module
├─ Removes 100+ lines of unused/broken code
└─ Simplifies architecture


FIX #3: Improve Value Extraction Regex
───────────────────────────────────────
File: tools/standards_enrichment_tool.py

Problem: Regex patterns too strict, don't match LLM output

Current Pattern:
    r"accuracy[:\s]+[±]?\s*(\d+\.?\d*)\s*%"

New Patterns (More Flexible):
    # Pattern 1: "accuracy: 0.25%" or "accuracy 0.25%"
    r"accuracy[:\s]*[~]?\s*(\d+\.?\d*)\s*%"

    # Pattern 2: "accuracy typically 0.25% to 0.5%"
    r"accuracy[:\s]*[~]?.*?(\d+\.?\d*)\s*%"

    # Pattern 3: Case-insensitive, allow text before/after
    r"(?i)accuracy.*?(\d+\.?\d*)\s*%"


FIX #4: Fix Schema Structure
────────────────────────────
File: tools/schema_tools.py

Problem: Schema returned as {"schema": {...}, "populated": {...}}

Solution:
    # When loading schema, ensure it returns actual fields
    schema = load_from_azure(product_type)

    # If nested, unwrap properly
    if "schema" in schema and isinstance(schema["schema"], dict):
        schema = schema["schema"]

    # Verify schema has fields
    if not schema or len(schema) == 0:
        # Return default empty schema structure
        return {
            "mandatory": {},
            "optional": {},
            "mandatory_requirements": [],
            "optional_requirements": []
        }


FIX #5: Add Semantic Value Extraction
──────────────────────────────────────
File: tools/standards_enrichment_tool.py

Problem: Regex fails even when LLM returns correct values

New Approach: Use LLM to extract structured values

    def extract_values_semantic(self, answer, schema_fields):
        # Use LLM to extract values from answer
        prompt = f"""
        Extract technical specifications from this text:
        {answer}

        For these fields: {schema_fields}

        Return as JSON: {{"field_name": "value", ...}}
        """

        result = self.llm.call(prompt)
        try:
            values = json.loads(result)
            return values
        except:
            # Fallback to regex
            return self.extract_values_regex(answer)


═══════════════════════════════════════════════════════════════════════════════
IMPLEMENTATION PRIORITY & IMPACT
═══════════════════════════════════════════════════════════════════════════════

Priority 1 (CRITICAL - Do First):
├─ FIX #1: JSON Parsing Robustness (agentic/standards_rag/standards_chat_agent.py)
│  └─ Impact: Recovers 50% of lost enrichment due to JSON errors
├─ FIX #2: Remove/Create Deep Agent (validation_tool.py)
│  └─ Impact: Prevents 0/0 field population fallback
└─ Estimated Time: 30 minutes

Priority 2 (HIGH - Do Next):
├─ FIX #3: Improve Value Extraction Regex (tools/standards_enrichment_tool.py)
│  └─ Impact: Improves field extraction from 0-5% to 30-50%
├─ FIX #4: Fix Schema Structure (tools/schema_tools.py)
│  └─ Impact: Ensures schema returns with proper structure
└─ Estimated Time: 45 minutes

Priority 3 (MEDIUM - Do After):
├─ FIX #5: Semantic Value Extraction (optional enhancement)
│  └─ Impact: Improves extraction to 60-80%
└─ Estimated Time: 30 minutes


═══════════════════════════════════════════════════════════════════════════════
EXPECTED RESULTS AFTER FIXES
═══════════════════════════════════════════════════════════════════════════════

Before Fixes:
├─ Schema generation: FAILS
├─ Fields populated: 0/35 (0%)
├─ Enrichment success: 0%
├─ Time wasted: 69-106 seconds
└─ API response: Empty schema

After Priority 1 Fixes:
├─ Schema generation: WORKS (with warnings)
├─ Fields populated: 2-5/35 (5-14%)
├─ Enrichment success: 50%
├─ Time needed: 30-60 seconds
└─ API response: Partial schema

After Priority 1+2 Fixes:
├─ Schema generation: MOSTLY WORKS
├─ Fields populated: 5-10/35 (14-28%)
├─ Enrichment success: 70%
├─ Time needed: 30-60 seconds
└─ API response: Basic schema (FUNCTIONAL)

After All Fixes:
├─ Schema generation: FULLY WORKS
├─ Fields populated: 20-30/35 (57-85%)
├─ Enrichment success: 95%
├─ Time needed: 30-60 seconds
└─ API response: Complete schema ✓

═══════════════════════════════════════════════════════════════════════════════
